name: Dozer Integration Test

on:
  workflow_dispatch:
    inputs:
      dozer.version:
        description: Expected Dozer version number. Leave blank to skip verifying the version.

env:
  CARGO_TERM_COLOR: always

concurrency:
  group: integration/${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  integration:
    timeout-minutes: 60
    strategy:
      matrix:
        os: [ubuntu-20.04, ubuntu-22.04, macos-12, macos-13]
        include:
          - os: ubuntu-20.04
            label: ubuntu-20-16-cores
          - os: ubuntu-22.04
            label: ubuntu-latest-16-cores
          - os: macos-12
            label: macos-12
          - os: macos-13
            label: macos-13
    runs-on: ${{ matrix.label }}
    steps:
      - uses: actions/checkout@v3

      - name: Install Dozer on Ubuntu
        if: ${{ matrix.os == 'ubuntu-20.04' || matrix.os == 'ubuntu-22.04' }}
        run: curl -sLO https://github.com/getdozer/dozer/releases/latest/download/dozer-linux-amd64.deb && sudo dpkg -i dozer-linux-amd64.deb

      - name: Install Protobuf on Ubuntu 20.04
        if: ${{ matrix.os == 'ubuntu-20.04' }}
        run: |
          curl -sLO https://github.com/protocolbuffers/protobuf/releases/download/v22.2/protoc-22.2-linux-x86_64.zip
          unzip protoc-22.2-linux-x86_64.zip -d /usr/local
      
      - name: Install Dozer on MacOs
        if: ${{ matrix.os == 'macos-12' || matrix.os == 'macos-13' }}
        run: brew tap getdozer/dozer && brew install dozer

      - name: Check Dozer version
        run: dozer -V
