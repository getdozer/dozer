name: Setup snowflake and kafka (debezium)

inputs:
  GITHUB_TOKEN:
    description: GITHUB token
    required: true
  SNOWFLAKE_SERVER:
    description: SNOWFLAKE_SERVER
    required: true
    default: ''
  SNOWFLAKE_USERNAME:
    description: SNOWFLAKE_USERNAME
    required: true
    default: ''
  SNOWFLAKE_PASSWORD:
    description: SNOWFLAKE_PASSWORD
    required: true
    default: SNOWFLAKE_PASSWORD
  SNOWFLAKE_DATABASE:
    description: SNOWFLAKE_DATABASE
    required: true
    default: SNOWFLAKE_DATABASE
  SNOWFLAKE_SCHEMA:
    description: SNOWFLAKE_SCHEMA
    required: true
    default: SNOWFLAKE_SCHEMA
  SNOWFLAKE_WAREHOUSE:
    description: SNOWFLAKE_WAREHOUSE
    required: true
    default: SNOWFLAKE_WAREHOUSE
  DEBEZIUM_TABLE_NAME:
    description: DEBEZIUM_TABLE_NAME
    required: true
    default: DEBEZIUM_TABLE_NAME
  DEBEZIUM_KAFKA_BROKER:
    description: DEBEZIUM_KAFKA_BROKER
    required: true
    default: DEBEZIUM_KAFKA_BROKER
  DEBEZIUM_KAFKA_TOPIC:
    description: DEBEZIUM_KAFKA_TOPIC
    required: true
    default: DEBEZIUM_KAFKA_TOPIC
  KAFKA_POSTGRES_USER:
    description: KAFKA_POSTGRES_USER
    required: true
    default: KAFKA_POSTGRES_USER
  KAFKA_POSTGRES_PASSWORD:
    description: KAFKA_POSTGRES_PASSWORD
    required: true
    default: KAFKA_POSTGRES_PASSWORD
  KAFKA_POSTGRES_HOST:
    description: KAFKA_POSTGRES_HOST
    required: true
    default: KAFKA_POSTGRES_HOST
  KAFKA_POSTGRES_PORT:
    description: KAFKA_POSTGRES_PORT
    required: true
    default: KAFKA_POSTGRES_PORT
  KAFKA_POSTGRES_DATABASE:
    description: KAFKA_POSTGRES_DATABASE
    required: true
    default: KAFKA_POSTGRES_DATABASE
  KAFKA_CONNECTOR_URL:
    description: KAFKA_CONNECTOR_URL
    required: true
    default: KAFKA_CONNECTOR_URL
  KAFKA_POSTGRES_SCHEMA:
    description: KAFKA_POSTGRES_SCHEMA
    required: true
    default: KAFKA_POSTGRES_SCHEMA

runs:
  using: "composite"
  steps:
    - name: Install Snowflake ODBC driver
      shell: bash
      run: curl ${SNOWFLAKE_DRIVER_URL} -o snowflake_driver.deb && sudo dpkg -i snowflake_driver.deb
      env:
        SNOWFLAKE_DRIVER_URL: https://sfc-repo.snowflakecomputing.com/odbc/linux/2.25.7/snowflake-odbc-2.25.7.x86_64.deb

    - uses: franzbischoff/replace_envs@v1
      env:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
        SERVER: ${{ inputs.SNOWFLAKE_SERVER }}
        USERNAME: ${{ inputs.SNOWFLAKE_USERNAME }}
        PASSWORD: ${{ inputs.SNOWFLAKE_PASSWORD }}
        DATABASE: ${{ inputs.SNOWFLAKE_DATABASE }}
        SCHEMA: ${{ inputs.SNOWFLAKE_SCHEMA }}
        WAREHOUSE: ${{ inputs.SNOWFLAKE_WAREHOUSE }}
      with:
        from_file: "config/test.snowflake.sample.yaml"
        to_file: "config/test.snowflake.sample.yaml"
        commit: "false"

    - uses: franzbischoff/replace_envs@v1
      env:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
        DEBEZIUM_TABLE_NAME: ${{ inputs.DEBEZIUM_TABLE_NAME }}
        DEBEZIUM_KAFKA_BROKER: ${{ inputs.DEBEZIUM_KAFKA_BROKER }}
        DEBEZIUM_KAFKA_TOPIC: ${{ inputs.DEBEZIUM_KAFKA_TOPIC }}
        KAFKA_POSTGRES_USER: ${{ inputs.KAFKA_POSTGRES_USER }}
        KAFKA_POSTGRES_PASSWORD: ${{ inputs.KAFKA_POSTGRES_PASSWORD }}
        KAFKA_POSTGRES_HOST: ${{ inputs.KAFKA_POSTGRES_HOST }}
        KAFKA_POSTGRES_PORT: ${{ inputs.KAFKA_POSTGRES_PORT }}
        KAFKA_POSTGRES_DATABASE: ${{ inputs.KAFKA_POSTGRES_DATABASE }}
        KAFKA_CONNECTOR_URL: ${{ inputs.KAFKA_CONNECTOR_URL }}
      with:
        from_file: "config/test.debezium.sample.yaml"
        to_file: "config/test.debezium.sample.yaml"
        commit: "false"

    - uses: franzbischoff/replace_envs@v1
      env:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
        DEBEZIUM_TABLE_NAME: ${{ inputs.DEBEZIUM_TABLE_NAME }}
        DEBEZIUM_KAFKA_TOPIC: ${{ inputs.DEBEZIUM_KAFKA_TOPIC }}
        KAFKA_POSTGRES_USER: ${{ inputs.KAFKA_POSTGRES_USER }}
        KAFKA_POSTGRES_HOST: ${{ inputs.KAFKA_POSTGRES_HOST }}
        KAFKA_POSTGRES_PORT: ${{ inputs.KAFKA_POSTGRES_PORT }}
        KAFKA_POSTGRES_DATABASE: ${{ inputs.KAFKA_POSTGRES_DATABASE }}
        KAFKA_POSTGRES_SCHEMA: ${{ inputs.KAFKA_POSTGRES_SCHEMA }}
        KAFKA_POSTGRES_PASSWORD: ${{ inputs.KAFKA_POSTGRES_PASSWORD }}
      with:
        from_file: "tests/connectors/debezium/register-postgres.test.sample.json"
        to_file: "tests/connectors/debezium/register-postgres.test.json"
        commit: "false"

    - uses: franzbischoff/replace_envs@v1
      env:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
        KAFKA_POSTGRES_USER: ${{ inputs.KAFKA_POSTGRES_USER }}
        KAFKA_POSTGRES_PASSWORD: ${{ inputs.KAFKA_POSTGRES_PASSWORD }}
        KAFKA_POSTGRES_HOST: ${{ inputs.KAFKA_POSTGRES_HOST }}
        KAFKA_POSTGRES_PORT: ${{ inputs.KAFKA_POSTGRES_PORT }}
        KAFKA_POSTGRES_DATABASE: ${{ inputs.KAFKA_POSTGRES_DATABASE }}
      with:
        from_file: "config/test.postgres.sample.yaml"
        to_file: "config/test.postgres.sample.yaml"
        commit: "false"